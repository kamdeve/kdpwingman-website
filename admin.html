<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admina - Full</title>
    <style>
        body { font-family: sans-serif; padding: 40px; background: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; }
        .settle-box { background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 5px solid #2196F3; margin: 20px 0; }
        .preview-box { background: white; padding: 15px; margin-top: 10px; border-radius: 5px; font-family: monospace; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .btn { padding: 8px 15px; cursor: pointer; color: white; border: none; border-radius: 5px; font-size:0.9rem; margin-right: 5px; }
        .btn-green { background: #28a745; }
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; }
        .tag { background: #ffeb3b; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        
        /* Styl dla historii */
        .history-row { background: #f8f9fa; color: #6c757d; }
        .history-row td { border-bottom: 1px solid #e9ecef; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëë Centrum Dowodzenia</h1>
        <div id="login-sec">
            <input type="password" id="pass" placeholder="Has≈Ço..."> <button onclick="login()" class="btn btn-blue">Login</button>
        </div>
        
        <div id="panel" style="display:none; margin-top: 20px;">
            <div style="display:flex; justify-content:space-between; background:#f8f9fa; padding:15px; border-radius:8px;">
                <div>Uczestnik√≥w: <strong id="count">0</strong></div>
                <div>Depozyty: <strong id="pool">0 z≈Ç</strong></div>
                <div>Kurs NBP: <strong id="rate" class="tag">...</strong></div>
            </div>

            <div class="settle-box">
                <h3>ü§ñ Automatyczne Rozliczenie MiesiƒÖca</h3>
                <div class="preview-box" id="preview">≈Åadowanie...</div>
                <br>
                <button class="btn btn-green" onclick="settle()">üöÄ Uruchom Procedurƒô Rozliczenia</button>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 rounded shadow-sm">
                <h4 style="margin-top: 20px; font-weight: bold; color: #475569;">üìú Archiwum Rozlicze≈Ñ:</h4>
                <table class="min-w-full mt-2 bg-white rounded overflow-hidden shadow-sm" style="font-size: 0.85rem;">
                    <thead class="bg-gray-200 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="py-2 px-3 text-left">Edycja</th>
                            <th class="py-2 px-3 text-left">Data Rozliczenia</th>
                            <th class="py-2 px-3 text-left">Zwr√≥cono ≈ÇƒÖcznie</th>
                        </tr>
                    </thead>
                    <tbody id="settlements-table-body" class="text-gray-600"></tbody>
                </table>
            </div>

            <h3>üí∏ Zlecenia Wyp≈Çat (Do zrobienia)</h3>
            <div class="bg-white rounded shadow overflow-hidden mb-8">
                <table id="withdraw-table" class="min-w-full">
                    <thead><tr><th>U≈ºytkownik / Konto</th><th>Kwota</th><th>Akcja</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <h3 style="margin-top: 40px; color: #6c757d;">üìú Historia Zrealizowanych Wyp≈Çat</h3>
            <div class="bg-white rounded shadow overflow-hidden mb-8">
                <table id="history-table" class="min-w-full">
                    <thead><tr><th>Data Zlecenia</th><th>Data Realizacji (Admin)</th><th>U≈ºytkownik / Konto</th><th>Kwota</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <h3 style="margin-top: 40px;">üìã Obecni Uczestnicy (Bie≈ºƒÖca Edycja)</h3>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table id="users-table" class="min-w-full">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="py-3 px-4 text-left">Okres</th>
                            <th class="py-3 px-4 text-left">Email</th>
                            <th class="py-3 px-4 text-left">Wp≈Çata</th>
                            <th class="py-3 px-4 text-left">Data do≈ÇƒÖczenia</th>
                            <th class="py-3 px-4 text-center">Akcja</th> </tr>
                    </thead>
                    <tbody class="text-sm"></tbody>
                </table>
            </div>

            
            <h3 style="margin-top: 40px; color: #a0134a;">‚úàÔ∏è Piloci Autopilota (Subskrybenci)</h3>
<div class="bg-white rounded shadow overflow-hidden">
    <table id="subs-table" class="min-w-full">
        <thead class="bg-pink-50 text-gray-600 uppercase text-xs">
            <tr><th>Email</th><th>Saldo Portfela</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


            <h3 style="margin-top: 40px; color: #64748b;">üï∞Ô∏è Uczestnicy z Poprzedniego MiesiƒÖca</h3>
            <div class="bg-gray-50 rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="min-w-full">
                    <thead class="bg-gray-200 text-gray-500 uppercase text-xs">
                        <tr>
                            <th class="py-3 px-4 text-left">Okres</th>
                            <th class="py-3 px-4 text-left">Email</th>
                            <th class="py-3 px-4 text-left">Wp≈Çata</th>
                            <th class="py-3 px-4 text-left">Data do≈ÇƒÖczenia</th>
                        </tr>
                    </thead>
                    <tbody id="past-users-table-body" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>

    <script>
        const API = "https://kdpwingmanv2backend-production.up.railway.app";
        let KEY = "";
        let USER_COUNT = 0;
        let CURRENT_RATE = 0;

        function login() { KEY = document.getElementById('pass').value; loadData(); }

        async function loadData() {
            try {
                const res = await fetch(`${API}/api/admin/participants?secret=${KEY}`);
                const data = await res.json();
                if(data.error) return alert("B≈ÇƒÖd has≈Ça");
                
                document.getElementById('login-sec').style.display = 'none';
                document.getElementById('panel').style.display = 'block';
                
                USER_COUNT = data.count;
                CURRENT_RATE = data.currentRate || 3.95;
                document.getElementById('count').innerText = USER_COUNT;
                document.getElementById('rate').innerText = CURRENT_RATE + " PLN";
                document.getElementById('pool').innerText = (USER_COUNT * 40).toFixed(2) + " z≈Ç";
                
                renderTables(data);
                updatePreview();
                const settleBtn = document.querySelector('button[onclick="settleMonth()"]');
            
            // Je≈õli przycisk istnieje w HTML, zaktualizuj go
            if(settleBtn) {
                if (data.isSettled) {
                    // Je≈õli miesiƒÖc zamkniƒôty -> Zablokuj przycisk
                    settleBtn.disabled = true;
                    settleBtn.innerText = "‚úÖ MIESIƒÑC ROZLICZONY";
                    // Szary kolor
                    settleBtn.className = "w-full bg-gray-500 cursor-not-allowed text-white font-bold py-3 rounded shadow";
                } else {
                    // Je≈õli miesiƒÖc otwarty -> Odblokuj
                    settleBtn.disabled = false;
                    settleBtn.innerText = "üöÄ Uruchom Procedurƒô Rozliczenia";
                    // Zielony kolor
                    settleBtn.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow transition";
                }
            }

            const settleBody = document.getElementById('settlements-table-body');
            if(settleBody && data.settlements) {
                settleBody.innerHTML = data.settlements.map(s => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 px-3 font-bold text-blue-600">${s.month_target}</td>
                        <td class="py-2 px-3">${new Date(s.processed_at).toLocaleString()}</td>
                        <td class="py-2 px-3 text-green-600 font-bold">-${s.total_refunded} z≈Ç/os.</td>
                    </tr>
                `).join('');
            }

            } catch(e) { alert("B≈ÇƒÖd po≈ÇƒÖczenia"); }

            
        }

        

        function updatePreview() {
            if(USER_COUNT === 0) return document.getElementById('preview').innerHTML = "Brak uczestnik√≥w.";
            const costPLN = 80 * CURRENT_RATE;
            const perPerson = costPLN / USER_COUNT;
            const refund = 40 - (perPerson + 10);
            let html = `Faktura: $80 * ${CURRENT_RATE} = <strong>${costPLN.toFixed(2)} PLN</strong><br>Zwrot: <strong style="color:${refund<0?'red':'green'}">${refund.toFixed(2)} z≈Ç</strong>`;
            document.getElementById('preview').innerHTML = html;
        }

        function renderTables(data) {
        // --- 1. OBECNI UCZESTNICY (Zaktualizowane o przycisk USUWANIA) ---
        const tUser = document.getElementById('users-table').querySelector('tbody');
        
        if (data.participants.length === 0) {
            tUser.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">Brak uczestnik√≥w w tym miesiƒÖcu.</td></tr>';
        } else {
            tUser.innerHTML = data.participants.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold text-blue-600">${p.month_target}</td>
                    <td class="p-3">${p.email}</td>
                    <td class="p-3 text-green-600 font-bold">${p.amount_paid} z≈Ç</td>
                    <td class="p-3 text-gray-500 text-xs">${new Date(p.joined_at).toLocaleString()}</td>
                    <td class="p-3 text-center flex items-center justify-center gap-2">
                        <input type="number" id="refund-input-${p.user_id}" value="${p.amount_paid}" 
                               style="width: 60px; padding: 4px; border: 1px solid #ccc; rounded; text-align: center;" 
                               title="Kwota zwrotu">
                        
                        <button onclick="removeParticipant(${p.user_id}, '${p.month_target}', '${p.email}')" 
                                class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded text-xs font-bold border border-red-200 transition">
                            ‚ùå Anuluj
                        </button>
                    </td>
                </tr>
            `).join('');
            // --- 5. SUBSKRYBENCI (WKLEJ TO NA SAMYM DOLE) ---
        const subsBody = document.getElementById('subs-table').querySelector('tbody');
        if(subsBody) { // Dodatkowy if, ≈ºeby nie wywali≈Ço b≈Çƒôdu jak nie znajdzie tabeli
            if(data.subscribers && data.subscribers.length > 0) {
                subsBody.innerHTML = data.subscribers.map(s => `
                    <tr class="border-b">
                        <td class="p-3 font-bold text-pink-600">‚úàÔ∏è ${s.email}</td>
                        <td class="p-3">${s.wallet_balance} z≈Ç</td>
                    </tr>
                `).join('');
            } else {
                subsBody.innerHTML = '<tr><td colspan="2" class="p-3 text-center text-gray-500">Brak subskrybent√≥w.</td></tr>';
            }
        }
        }

        // --- 2. UCZESTNICY Z POPRZEDNIEGO MIESIƒÑCA (NOWO≈öƒÜ) ---
        // (Upewnij siƒô, ≈ºe doda≈Çe≈õ odpowiedni HTML dla tej tabeli, jak w instrukcji wy≈ºej)
        const pastTableBody = document.getElementById('past-users-table-body');
        if(pastTableBody) {
             if(!data.pastParticipants || data.pastParticipants.length === 0) {
                pastTableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Brak danych z poprzedniego miesiƒÖca.</td></tr>';
             } else {
                pastTableBody.innerHTML = data.pastParticipants.map(p => `
                    <tr class="border-b hover:bg-gray-50 bg-gray-50">
                        <td class="p-3 text-gray-500">${p.month_target}</td>
                        <td class="p-3 text-gray-600">${p.email}</td>
                        <td class="p-3 text-gray-600">${p.amount_paid} z≈Ç</td>
                        <td class="p-3 text-gray-400 text-xs">${new Date(p.joined_at).toLocaleString()}</td>
                    </tr>
                `).join('');
             }
        }

        // --- 3. OCZEKUJƒÑCE WYP≈ÅATY (Twoja wersja ze screena - bez zmian) ---
        // Szukamy tabeli po ID 'withdraw-table' (tak masz na screenie) lub 'withdrawals-table'
        const withdrawTableEl = document.getElementById('withdraw-table') || document.getElementById('withdrawals-table');
        
        if (withdrawTableEl) {
            const tWith = withdrawTableEl.querySelector('tbody');
            tWith.innerHTML = data.withdrawals.length ? data.withdrawals.map(w => `
                <tr style="background: #fff3cd;">
                    <td><strong>${w.email}</strong><br><span style="font-size:0.8rem; color:#666;">Data: ${new Date(w.created_at).toLocaleString()}</span></td>
                    <td style="color:red; font-weight:bold;">-${w.amount} z≈Ç</td>
                    <td>
                        <button class="btn btn-blue" style="margin-right:5px;" onclick="navigator.clipboard.writeText('${w.account_number}')">Kopiuj</button>
                        <button class="btn btn-red" onclick="confirmWithdraw(${w.id}, '${w.email}', ${w.amount})">Zrealizuj</button>
                        <br><span style="font-size:0.7rem; font-family:monospace;">${w.account_number}</span>
                    </td>
                </tr>`).join('') : '<tr><td colspan="3">Brak zlece≈Ñ.</td></tr>';
        }

        // --- 4. HISTORIA WYP≈ÅAT (Twoja wersja ze screena - bez zmian) ---
        const historyTableEl = document.getElementById('history-table');
        if (historyTableEl) {
            const tHist = historyTableEl.querySelector('tbody');
            tHist.innerHTML = data.history && data.history.length ? data.history.map(h => `
                <tr class="history-row">
                    <td>${new Date(h.created_at).toLocaleDateString()}</td>
                    <td><strong>${h.completed_at ? new Date(h.completed_at).toLocaleString() : '---'}</strong></td>
                    <td>${h.email}<br><span style="font-size:0.8rem;">${h.account_number}</span></td>
                    <td>-${h.amount} z≈Ç</td>
                </tr>`).join('') : '<tr><td colspan="4">Pusta historia.</td></tr>';
        }
    }

        async function confirmWithdraw(id, email, amount) {
            if(!confirm(`Czy zrealizowa≈Çe≈õ przelew ${amount} z≈Ç dla ${email}?`)) return;
            const res = await fetch(`${API}/api/admin/confirm-withdraw`, {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ secret: KEY, withdrawId: id })
            });
            loadData();
        }

        async function settle() {
            if(!confirm("Rozliczyƒá?")) return;
            const res = await fetch(`${API}/api/admin/settle`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ secret: KEY }) });
            const d = await res.json(); alert(d.message || d.error); loadData();
        }

        async function removeParticipant(userId, month, email) {
        // Pobierz warto≈õƒá z pola input obok przycisku
        const inputEl = document.getElementById(`refund-input-${userId}`);
        const customAmount = inputEl ? inputEl.value : null;

        if(!confirm(`‚ö†Ô∏è CZY NA PEWNO?\n\nUsuwasz: ${email}\nZwrot do portfela: ${customAmount} z≈Ç\n\nKliknij OK, aby potwierdziƒá.`)) return;

        try {
            const res = await fetch(`${API}/api/admin/remove-participant`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // Wysy≈Çamy 'customRefund'
                body: JSON.stringify({ secret: KEY, userId, month, customRefund: customAmount })
            });
            const data = await res.json();
            
            if(data.success) {
                alert("‚úÖ SUKCES: " + data.message);
                loadData(); // Od≈õwie≈º tabelƒô
            } else {
                alert("B≈ÇƒÖd: " + data.error);
            }
        } catch(e) { alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + e.message); }
    }

    </script>
</body>
</html>