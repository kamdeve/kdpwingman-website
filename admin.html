<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admina - KDP Wingman</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center; }
        .admin-box { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 900px; /* Zwiększamy szerokość dla tabeli */ }
        .hidden { display: none !important; }
        .user-table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px; }
        .user-table th, .user-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .user-table th { background-color: #f2f2f2; }
        /* Nowe style dla siatki ze statystykami */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 1.5rem; margin: 20px 0; }
        .stats-grid div { background-color: #f8f9fa; padding: 20px; border-radius: 6px; }
    </style>
</head>
<body>

    <div class="admin-container">
        <div class="admin-box">
            <div id="admin-login-view">
                <h2>Panel Administratora</h2>
                <p>Zaloguj się, aby zobaczyć statystyki.</p>
                <form id="admin-login-form" class="register-form">
                    <input type="email" id="admin-email" placeholder="E-mail admina" required>
                    <input type="password" id="admin-password" placeholder="Hasło" required>
                    <button type="submit">Zaloguj się</button>
                    <p id="admin-login-error" style="color: red; font-size: 14px; margin-top: 10px;"></p>
                </form>
            </div>

            <div id="admin-stats-view" class="hidden">
                <h2>Statystyki Aplikacji</h2>
                <div id="stats-content" class="stats-grid"></div>
                <div id="user-list-container"></div>
                <button id="logout-button" class="btn btn-outline" style="margin-top: 20px;">Wyloguj</button>
            </div>
        </div>
    </div>

<script>
    const loginView = document.getElementById('admin-login-view');
    const statsView = document.getElementById('admin-stats-view');
    const loginForm = document.getElementById('admin-login-form');
    const statsContent = document.getElementById('stats-content');
    const userListContainer = document.getElementById('user-list-container');
    const loginError = document.getElementById('admin-login-error');
    const logoutButton = document.getElementById('logout-button');

    const API_URL = 'https://kdpwingman-backend-production.up.railway.app';
    let authToken = localStorage.getItem('admin_token');

    // Funkcja do pobierania statystyk i listy użytkowników
    async function fetchStatsAndUsers() {
        if (!authToken) { showLoginView(); return; }

        try {
            // Pobieranie ogólnych statystyk (teraz z nową daną)
            const statsResponse = await fetch(`${API_URL}/api/admin/stats`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            if (!statsResponse.ok) throw new Error('Błąd pobierania statystyk.');
            const statsData = await statsResponse.json();
            
            // Wyświetlanie obu statystyk
            statsContent.innerHTML = `
                <div>Wszyscy zweryfikowani:<br><strong>${statsData.verifiedUsers}</strong></div>
                <div>Aktywni (7 dni):<br><strong>${statsData.activeLast7Days}</strong></div>
            `;

            // Pobieranie listy użytkowników
            const usersResponse = await fetch(`${API_URL}/api/admin/users`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            if (!usersResponse.ok) throw new Error('Błąd pobierania listy użytkowników.');
            const usersData = await usersResponse.json();
            displayUserTable(usersData);

            showStatsView();

        } catch (error) {
            console.error(error);
            handleAuthError(error.message);
        }
    }
    
    // Funkcja do renderowania tabeli użytkowników (teraz z nową kolumną)
    function displayUserTable(users) {
        let tableHTML = '<table class="user-table"><thead><tr><th>ID</th><th>Email</th><th>Rola</th><th>Zweryfikowany</th><th>Data Rejestracji</th><th>Ostatnie Logowanie</th></tr></thead><tbody>';
        users.forEach(user => {
            const registrationDate = new Date(user.created_at).toLocaleString('pl-PL');
            // Sprawdzamy, czy data ostatniego logowania istnieje, i formatujemy ją
            const lastLoginDate = user.last_login ? new Date(user.last_login).toLocaleString('pl-PL') : 'Brak';

            tableHTML += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.is_verified ? 'Tak' : 'Nie'}</td>
                    <td>${registrationDate}</td>
                    <td>${lastLoginDate}</td>
                </tr>
            `;
        });
        tableHTML += '</tbody></table>';
        userListContainer.innerHTML = tableHTML;
    }

    // Funkcja do logowania
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;

        try {
            const response = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);

            authToken = data.token;
            localStorage.setItem('admin_token', authToken);
            fetchStatsAndUsers();
        } catch (error) {
            loginError.textContent = error.message;
        }
    });
    
    function handleAuthError(message) {
        localStorage.removeItem('admin_token');
        showLoginView();
        loginError.textContent = message;
    }

    // Pozostałe funkcje (wylogowanie, przełączanie widoków)
    logoutButton.addEventListener('click', () => { authToken = null; localStorage.removeItem('admin_token'); showLoginView(); });
    function showLoginView() { loginView.classList.remove('hidden'); statsView.classList.add('hidden'); }
    function showStatsView() { loginView.classList.add('hidden'); statsView.classList.remove('hidden'); }

    // Sprawdź przy starcie, czy użytkownik jest już zalogowany jako admin
    if (authToken) {
        fetchStatsAndUsers();
    } else {
        showLoginView();
    }
</script>
</body>
</html>