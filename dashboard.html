<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Tw√≥j Portfel - KDP Wingman</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .box { background: #1e293b; padding: 40px; border-radius: 15px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .balance { font-size: 2.5rem; font-weight: bold; color: #00C851; margin: 20px 0; }
        .hidden { display: none; }
        
        /* Style zak≈Çadek */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .tab-label { cursor: pointer; padding: 8px 12px; background: #334155; border-radius: 6px; font-size: 0.85rem; opacity: 0.7; transition: 0.2s; border: 1px solid transparent; }
        .tab-label:hover { opacity: 1; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .tab-label { background: #3b82f6; opacity: 1; border-color: #60a5fa; font-weight: bold; }

        .form-section { text-align: left; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 10px; }
        label { font-size: 0.8rem; color: #94a3b8; margin-left: 2px; }
    </style>
</head>
<body>

    <div id="login-view" class="box">
        <h2>üîê Zaloguj siƒô do portfela</h2>
        <input type="email" id="email" placeholder="Tw√≥j e-mail">
        <input type="password" id="pass" placeholder="Has≈Ço">
        <button class="btn btn-blue" onclick="login()">Zaloguj</button>
        <p id="login-msg" style="color:#ef4444; margin-top:10px;"></p>
    </div>

    <div id="dash-view" class="box hidden">
        <h3>Tw√≥j Portfel</h3>
        <div class="balance" id="balance">0.00 z≈Ç</div>
        
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <label style="font-size: 1rem; color: white; margin-bottom: 10px; display:block;">Ile chcesz wyp≈Çaciƒá?</label>
            <input type="number" id="withdraw-amount" placeholder="np. 10.00">

            <p style="margin: 20px 0 10px 0; font-size: 0.9rem; color: #cbd5e1;">Gdzie wys≈Çaƒá pieniƒÖdze?</p>

            <div class="tabs">
                <label>
                    <input type="radio" name="method" value="pl" checked onchange="switchTab('pl')">
                    <span class="tab-label">üáµüá± Polska</span>
                </label>
                <label>
                    <input type="radio" name="method" value="uk" onchange="switchTab('uk')">
                    <span class="tab-label">üá¨üáß UK</span>
                </label>
                <label>
                    <input type="radio" name="method" value="other" onchange="switchTab('other')">
                    <span class="tab-label">üåç Inne / PayPal</span>
                </label>
            </div>

            <div id="form-pl" class="form-section">
                <label>Numer konta (26 cyfr)</label>
                <input type="text" id="pl-account" placeholder="XX XXXX XXXX..." maxlength="32" oninput="formatPL(this)">
            </div>

            <div id="form-uk" class="form-section hidden">
                <label>Imiƒô i Nazwisko (Account Holder Name)</label>
                <input type="text" id="uk-name" placeholder="np. John Smith">
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Sort Code</label>
                        <input type="text" id="uk-sort" placeholder="11-22-33" maxlength="8">
                    </div>
                    <div style="flex:2">
                        <label>Account Number</label>
                        <input type="text" id="uk-acc" placeholder="12345678" maxlength="10">
                    </div>
                </div>
            </div>

            <div id="form-other" class="form-section hidden">
                <label>IBAN lub E-mail PayPal</label>
                <input type="text" id="other-data" placeholder="np. DE12... lub jan@gmail.com">
            </div>

            <button class="btn btn-blue" onclick="withdraw()">üí∏ Zleƒá Wyp≈Çatƒô</button>
        </div>

        <button class="btn btn-red" onclick="logout()">Wyloguj</button>
    </div>

    <script>
        const API = "https://kdpwingmanv2backend-production.up.railway.app";
        let userEmail = "";

        // Prze≈ÇƒÖczanie widok√≥w (Logika zak≈Çadek)
        function switchTab(type) {
            document.getElementById('form-pl').classList.add('hidden');
            document.getElementById('form-uk').classList.add('hidden');
            document.getElementById('form-other').classList.add('hidden');
            
            document.getElementById('form-' + type).classList.remove('hidden');
        }

        // Formatowanie polskiego konta (Dodaje spacje co 4 cyfry)
        function formatPL(input) {
            let v = input.value.replace(/\D/g, '').substring(0, 26);
            // Dodaj spacje co 4 znaki (XX XXXX XXXX...)
            let formatted = v.replace(/(^.{2})|(.{4})/g, '$& ').trim();
            input.value = formatted;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            const msg = document.getElementById('login-msg');

            try {
                const res = await fetch(`${API}/api/login`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ email, password: pass })
                });
                if(!res.ok) throw new Error("B≈Çƒôdne dane");
                
                userEmail = email;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dash-view').classList.remove('hidden');
                refreshBalance();
            } catch(e) { msg.innerText = e.message; }
        }

        async function refreshBalance() {
            const res = await fetch(`${API}/api/user/status`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ email: userEmail })
            });
            const data = await res.json();
            document.getElementById('balance').innerText = data.wallet_balance.toFixed(2) + " z≈Ç";
        }

        async function withdraw() {
            const amount = document.getElementById('withdraw-amount').value;
            const type = document.querySelector('input[name="method"]:checked').value;
            
            let finalAccountString = "";

            // Logika sklejania danych w zale≈ºno≈õci od wyboru
            if (type === 'pl') {
                const num = document.getElementById('pl-account').value;
                if(num.length < 20) return alert("Polski numer konta jest za kr√≥tki!");
                finalAccountString = `[PL] ${num}`;
            } 
            else if (type === 'uk') {
                const name = document.getElementById('uk-name').value;
                const sort = document.getElementById('uk-sort').value;
                const acc = document.getElementById('uk-acc').value;
                if(!name || !sort || !acc) return alert("Uzupe≈Çnij wszystkie dane dla UK!");
                finalAccountString = `[UK] ${name} | SC: ${sort} | ACC: ${acc}`;
            } 
            else {
                const other = document.getElementById('other-data').value;
                if(!other) return alert("Wpisz dane do przelewu!");
                finalAccountString = `[INNE] ${other}`;
            }

            if(!amount || amount <= 0) return alert("Wpisz kwotƒô!");
            if(!confirm(`Czy wyp≈Çaciƒá ${amount} z≈Ç na:\n${finalAccountString}?`)) return;

            try {
                const res = await fetch(`${API}/api/wallet/withdraw`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    // Wysy≈Çamy gotowy, sklejony tekst do bazy
                    body: JSON.stringify({ email: userEmail, amount: amount, accountNumber: finalAccountString })
                });
                const data = await res.json();
                
                if(res.ok) {
                    alert("‚úÖ Sukces! Zlecenie przyjƒôte.\nOczekuj przelewu do 24h.");
                    // Wyczy≈õƒá pola
                    document.getElementById('withdraw-amount').value = "";
                    refreshBalance();
                } else {
                    alert("B≈ÇƒÖd: " + data.error);
                }
            } catch(e) { alert("B≈ÇƒÖd po≈ÇƒÖczenia"); }
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>